<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <title>
        陈柄宏的学习笔记
    </title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <link id="code-css" rel="stylesheet" href="monokai-sublime.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
    <style type="text/css">
        body {
            font-family: 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
        }

        h2 {
            text-align: center;
        }

        a {
            text-decoration: none;
        }

        ::selection {
            background: #262a30;
            color: #fff;
        }

        .header {
            top: 0;
            width: 100%;
            height: 80px;
            z-index: 9999;
            color: #333;
            background-color: #f4f4f4;
        }

        .title {
            height: 80px;
            line-height: 80px;
            margin-left: calc(15% + 130px);
            color: black;
            font-size: 22px;
            font-weight: bolder;
        }

        .left {
            float: left;
            width: 220px;
            height: 100%;
            margin-top: -80px;
            background-color: #333;
            color: white;
            position: fixed;
            z-index: 9999;
        }

        .left .ajax-link {
            font-size: 16px;
            padding-left: 10px;
            height: 45px;
            line-height: 45px;
            width: 210px;
        }

        .selected {
            color: firebrick;
            background-color: #f4f4f4;
        }

        .center {
            width: 70%;
            left: calc(15% + 110px);
            top: 12px;
            margin-bottom: 40px;
            z-index: 1;
            position: relative;
            padding: 20px;
        }

        .list-item {
            min-height: 70px;
        }

        .ajax-link {
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
        }

        .left .ajax-link:hover,
        .center .ajax-link:hover {
            text-decoration: underline;
        }

        .list-item .ajax-link {
            font-size: 22px;
        }

        .preview {
            color: #777;
            font-size: 16px;
            margin-top: 10px;
        }

        .one-row-code {
            display: block;
            text-align: center;
        }

        .code-copy {
            opacity: 0.3;
            top: 0;
            right: 0;
            float: right;
            padding: 3px;
            cursor: pointer;
            color: #888;
            background-color: white;
            border-radius: 1px;
        }

        .code-copy:hover {
            opacity: 1;
        }

        .code-row-no {
            -moz-user-select: none;
            -o-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border-right: 1px solid #333;
        }

        .hljs ul {
            padding: 0;
            margin: 0 10px 0 0px;
            text-align: right;
            list-style-type: none;
        }
    </style>
    <script src="jquery-2.1.1.min.js"></script>
    <script id="code-script" src="highlight.pack.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
</head>

<body>
    <div class="header">
        <div class="title ajax-link" data-url="0">
            <img src="favicon.ico" style="width: 22px; margin-left: -28px;" />
            陈柄宏的学习笔记
        </div>
    </div>
    <div class="left">
        _left_
    </div>
    <div class="center">
    </div>
    <script type="text/javascript">
        // 网站的所有页面列表
        var pages = _pageMap_;

        // 网站url
        var baseurl = location.href.split('?')[0];

        // 假链接的跳转事件
        function ajaxJump(url, isForward = false) {
            // 解析页面的url和其index
            var index = +url;
            if (isNaN(index)) {
                index = pages.indexOf(decodeURIComponent(url));
            } else {
                url = pages[index];
            }
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.status != 200) return;
                if (xhr.readyState != 4) return;
                var currentUrl = xhr.responseURL.replace(baseurl, '');
                var html = xhr.response;
                // markdown
                if (xhr.responseURL.indexOf('.md') != -1) {
                    // marked.js会把\\(换行)改成\
                    html = html.replace(/\\\\/g, '\\\\\\\\').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                    html = marked(html);
                }
                // latex
                html = html.replace(/\$\$([\s\S]*?)\$\$/g, '<code class="language-math one-row-code">$1</code>');
                html = html.replace(/\$([\s\S]*?)\$/g, '<code class="language-math">$1</code>');
                // 相对路径
                var reg1 = new RegExp(/(src|href)="http/);
                var reg2 = new RegExp(/"(.*?)"/);
                var hrefs = html.match(/(href|src)="(.*?)"/g);
                var set = new Set();
                if (hrefs != null && hrefs.length) {
                    for (var i = 0; i < hrefs.length; i++) {
                        var href = hrefs[i];
                        if (reg1.test(href)) continue;
                        var _url = href.match(reg2)[1];
                        if (set.has(_url)) continue;
                        set.add(_url);
                        html = html.replace(_url, relUrl2AbsUrl(_url, currentUrl));
                    }
                }
                $('.center').html(html);
                // .center的ajax页面渲染完成后
                setTimeout(function () {
                    // 代码高亮
                    $('pre').each(function () {
                        var code = this.innerText;
                        $(this).addClass('hljs').html(hljs.highlightAuto(code).value);
                        var $copy = $('<span class="code-copy">复制</span>');
                        var codesplits = code.split('\n');
                        var ulHtml = [];
                        ulHtml.push('<ul class="code-row-no">');
                        for (var i = 0; i < codesplits.length; i++) {
                            ulHtml.push('<li>', i + 1, '</li>');
                        }
                        ulHtml.push('</ul>');
                        var $ul = $(ulHtml.join(''));
                        $ul.css({
                            'float': 'left'
                        });
                        $(this).prepend($ul);
                        $(this).prepend($copy);
                        $copy.click(function () {
                            copy(code);
                            $copy.text('已复制');
                            setTimeout(function () {
                                $copy.text('复制');
                            }, 1000);
                        });
                    });
                    // 禁用站内链接的默认跳转功能
                    $('a').each(function () {
                        var href = $(this).attr('href');
                        if (href.lastIndexOf('.md') == href.length - 3 || pages.indexOf(href) != -1) {
                            $(this).attr('href', 'javascript:void(0);').attr('data-url', href.replace(baseurl, '')).addClass('ajax-link forward');
                        } else {
                            $(this).attr('target', '_blank');
                        }
                    });
                    // 图片居中
                    $('.center img').each(function(){
                        var $img = $(this);
                        var $parent = $img.parent();
                        if($parent.attr('align') != 'center'){
                            var $prev = $img.prev();
                            var $newParent = $('<div align=center></div>');
                            $newParent.append($img);
                            if($prev.length == 0){
                                $newParent.appendTo($parent)
                            }else{
                                $newParent.insertAfter($prev);
                            }
                        }
                    });
                    // latex渲染
                    $('code.language-math').each(function () {
                        try {
                            // marked.js解析会将$$\%$$解析成% 需要替换回来
                            var raw = $(this).text().replace(/\%/g, '\\%');
                            katex.render(raw, this);
                        } catch (e) {
                            console.error(e);
                            console.error(raw);
                        }
                    });
                }, 200);
                // 判断是否是打开新页面还是替换页面
                if (isForward) {
                    history.pushState(null, '', baseurl + '?' + index);
                } else {
                    if (index == 0) {
                        history.replaceState(null, '', baseurl);
                    } else {
                        history.replaceState(null, '', baseurl + '?' + index);
                    }
                }
                // 选中与当前页面匹配左边笔记分类标签
                var $currentTag = $('.left .ajax-link[data-url=' + index + ']');
                if ($currentTag.length && !$currentTag.hasClass('selected')) {
                    $('.left .ajax-link').removeClass('selected');
                    $currentTag.addClass('selected');
                }
            }
            xhr.open('GET', url + '?_t=' + new Date());
            xhr.send();
        }

        // 用当前url计算出相对路径的绝对路径
        function relUrl2AbsUrl(url, currentUrl) {
            var urlSplit = url.split('/');
            var cUrlSplit = currentUrl.split('/');
            cUrlSplit.length--;
            while (urlSplit.length > 0) {
                var cmd = urlSplit[0];
                if (cmd == '..' || cmd == '.' || cmd == '') {
                    urlSplit.shift();
                    if (cmd == '..') {
                        cUrlSplit.length--;
                    }
                } else {
                    break;
                }
            }
            return cUrlSplit.join('/') + '/' + urlSplit.join('/');
        }

        // 绑定假链接的跳转事件
        window.onclick = function (e) {
            var el = e.target;
            if (el.classList.contains('ajax-link')) {
                ajaxJump(el.getAttribute('data-url'), el.classList.contains('forward'));
                if (el.parentNode.classList.contains('left')) {
                    $('.left .ajax-link').each(function () {
                        this.classList.remove('selected');
                    })
                    el.classList.add('selected');
                }
            }
        }

        // 复制代码
        function copy(str) {
            var save = function (e) {
                e.clipboardData.setData('text/plain', str);//下面会说到clipboardData对象
                e.preventDefault();//阻止默认行为
            }
            document.addEventListener('copy', save);
            document.execCommand("copy");//使文档处于可编辑状态，否则无效
        }

        // 浏览器地址栏变化(手动改变url,回退)事件 将ajax跳转
        function pageLoad() {
            var index = location.search.replace('?', '');
            if (location.href == baseurl) {
                url = 'generate_page/generate_page_0.首页.html';
            }
            ajaxJump(index);
        }

        $(function () {
            window.onpopstate = pageLoad;
            window.onload = pageLoad;
        });
    </script>
</body>

</html>